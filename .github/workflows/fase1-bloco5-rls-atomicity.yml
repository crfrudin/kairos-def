name: FASE 1 · BLOCO 5 · PASSOS 2-3 (RLS + Atomicidade)

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  rls_atomicity:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    env:
      DATABASE_URL: ${{ secrets.KAIROS_DATABASE_URL }}
      TEST_USER_A_ID: ${{ secrets.KAIROS_TEST_USER_A_ID }}
      TEST_USER_B_ID: ${{ secrets.KAIROS_TEST_USER_B_ID }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install
        run: npm ci

      - name: Pre-check 1 — env presence
        run: node -e "const req=['DATABASE_URL','TEST_USER_A_ID','TEST_USER_B_ID']; for (const k of req){ if(!process.env[k]){ console.error('Missing env:',k); process.exit(1);} } console.log('env ok');"

      - name: Pre-check 2 — DB connectivity (select 1)
        run: node -e "const {Client}=require('pg');(async()=>{const c=new Client({connectionString:process.env.DATABASE_URL, ssl:{rejectUnauthorized:false}});await c.connect();const r=await c.query('select 1 as ok');console.log(r.rows[0]);await c.end();})().catch(e=>{console.error(e.message||e);process.exit(1);});"

      - name: Pre-check 3 — role must NOT be superuser/bypassrls
        run: |
          node -e "const {Client}=require('pg');(async()=>{const c=new Client({connectionString:process.env.DATABASE_URL, ssl:{rejectUnauthorized:false}});await c.connect();const r=await c.query(\`select current_user as rolname, (select rolbypassrls from pg_roles where rolname=current_user) as rolbypassrls, (select rolsuper from pg_roles where rolname=current_user) as rolsuper\`);console.log(r.rows[0]);const x=r.rows[0];if(x.rolsuper||x.rolbypassrls){console.error('INVALID ROLE: must not be superuser/bypassrls');process.exit(2);}await c.end();})().catch(e=>{console.error(e.message||e);process.exit(1);});"

      - name: Run tests (vitest)
        run: npm run test
